<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿æƒ -å¹¿ä½›è‚‡åŸé™…åˆ—è½¦å‡ºå‘æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .current-time {
            font-size: 2em;
            margin-bottom: 10px;
            color: #fff;
        }        .station-name {
            font-size: 1.5em;
            color: #fff;
        }

        .station-input-container {
            margin-top: 10px;
        }

        .station-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 1.2em;
            color: #333;
            text-align: center;
            min-width: 200px;
            outline: none;
            transition: all 0.3s ease;
        }

        .station-input:focus {
            border-color: #ff8c00;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            background: white;
        }

        .station-suggestions {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
        }        .station-suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            color: #333;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
            user-select: none; /* é˜²æ­¢æ–‡æœ¬é€‰æ‹© */
        }

        .station-suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .station-suggestion-item:active {
            background-color: #e0e0e0;
        }

        .station-suggestion-item:last-child {
            border-bottom: none;
        }

        .departure-board {
            background: #16213e;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .board-header {
            display: grid;
            grid-template-columns: 80px 120px 110px 170px 100px 100px auto;
            gap: 10px;
            padding: 15px 10px;
            background: #0f3460;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 14px;
        }

        .train-item {
            margin-bottom: 15px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(15, 52, 96, 0.3);
            transition: all 0.3s ease;
        }

        .train-item:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(5px);
        }

        .train-item.next-departure {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.2));
            border-left: 4px solid #ffd700;
            animation: pulse 2s infinite;
        }

        .train-row {
            display: grid;
            grid-template-columns: 80px 120px 100px 150px 80px 120px auto;
            gap: 10px;
            padding: 15px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            align-items: center;
        }

        .train-row:hover {
            background: rgba(102, 126, 234, 0.1);
        }        .train-row.next-departure {
            background: transparent;
        }

        /* ä¸åœé åˆ—è½¦çš„æ ·å¼ */
        .train-item.not-stopping {
            min-height: 60px; /* ç¼©å°è¡Œé«˜ */
        }

        .train-item.not-stopping .train-row {
            grid-template-columns: 80px 120px 100px 150px 80px 120px auto;
            padding: 10px; /* å‡å°å†…è¾¹è· */
            align-items: center;
        }

        .passing-display {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px; /* ç¼©å°é«˜åº¦ */
            background: rgba(149, 165, 166, 0.1);
            border-radius: 5px;
            border: 1px dashed rgba(149, 165, 166, 0.3);
        }

        .not-stopping-message {
            color: #95a5a6;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            padding: 8px 15px;
        }.stations-display {
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-width: 300px;
            max-width: 100%;
            overflow: hidden;
            position: relative;
        }        .stations-track {
            display: flex;
            align-items: flex-start; /* æ”¹ä¸ºé¡¶éƒ¨å¯¹é½ */
            gap: 2px;
            position: relative;
            height: 90px; /* ä»100pxæ”¹ä¸º90pxï¼Œç¨å¾®å‹ç¼©é«˜åº¦ */
            padding-top: 15px; /* æ·»åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œä¸ºç«™åç•™å‡ºç©ºé—´ */
            transition: transform 0.5s ease;
            will-change: transform;
        }

        .stations-scroll-container {
            overflow: hidden;
            width: 100%;
            position: relative;
        }        .stations-track.scrolling {
            animation: autoScroll var(--scroll-duration) linear forwards;
        }

        .stations-track.resetting {
            transition: transform 0.8s ease-in-out;
            transform: translateX(0) !important;
        }

        .stations-track.paused {
            animation-play-state: paused;
        }

        @keyframes autoScroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(var(--scroll-distance)); }
        }

        .scroll-indicator {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(90deg, transparent, rgba(22, 33, 62, 0.8));
            pointer-events: none;
            z-index: 3;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .scroll-indicator.visible {
            opacity: 1;
        }

        .station-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 40px;
            position: relative;
        }        .station-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34495e;
            border: 1px solid #34495e;
            position: relative;
            z-index: 2;
            margin-top: -8px; /* å‘ä¸Šç§»åŠ¨ç«™ç‚¹åœ†ç‚¹ */
        }

        .station-dot.stop {
            background: #ffd700;
            border-color: #ffd700;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }

        .station-dot.current {
            background: #e74c3c;
            border-color: #e74c3c;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.6);
            animation: currentStation 2s infinite;
        }

        @keyframes currentStation {
            0%, 100% { box-shadow: 0 0 8px rgba(231, 76, 60, 0.6); }
            50% { box-shadow: 0 0 15px rgba(231, 76, 60, 1); }
        }        .station-name-label {
            position: absolute;
            top: 4px; /* ä»12pxæ”¹ä¸º4pxï¼Œå‘ä¸Šç§»åŠ¨8px */
            padding-right: 2px;
            font-size: 14px;
            color: #95a5a6;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            white-space: nowrap;
            /* text-align: center; */
            width: 32px;
            height: 80px;
            overflow: hidden;
            line-height: 1;
        }        .station-name-label.highlight {
            color: #ffd700;
            font-weight: bold;
        }

        .station-name-label.passed {
            color: #555;
            opacity: 0.6;
        }

        .station-dot.passed {
            background: #555;
            border-color: #555;
            box-shadow: none;
        }.track-line {
            position: absolute;
            top: 12%; /* ä»50%æ”¹ä¸º35%ï¼Œå‘ä¸Šç§»åŠ¨è½¨é“çº¿ */
            left: 20px; /* ä»ç¬¬ä¸€ä¸ªç«™ç‚¹ä¸­å¿ƒå¼€å§‹ */
            height: 2px;
            background: linear-gradient(90deg, #34495e 0%, #2c3e50 50%, #34495e 100%);
            z-index: 1;
            transform: translateY(-50%);
            /* å®½åº¦ç°åœ¨é€šè¿‡å†…è”æ ·å¼åŠ¨æ€è®¾ç½® */
        }

        .stations-info {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        @keyframes pulse {
            0%, 100% { border-left-color: #ffd700; }
            50% { border-left-color: #ff8c00; }
        }

        .train-type {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }        .express {
            background: #e74c3c;
            color: white;
        }

        .super-express {
            background: #8e44ad;
            color: white;
            position: relative;
        }

        .super-express::before {
            content: "ç‰¹";
            position: absolute;
            left: -3px;
            top: -3px;
            background: #ffd700;
            color: #8e44ad;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .regular {
            background: #3498db;
            color: white;
        }

        .time {
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
        }

        .destination {
            font-weight: bold;
            color: #fff;
        }

        .platform {
            background: #34495e;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            text-align: center;
        }        .on-time { background: #27ae60; color: white; }        .delay { background: #e74c3c; color: white; }        .boarding { 
            background: #ebbc00; 
            color: white; 
            font-weight: bold;
            animation: slowBreathing 3s ease-in-out infinite;
        }
        .boarding.boarding-soon { 
            animation: blink 1.5s infinite;
        }
        .departed { background: #7f8c8d; color: white; }
        .passing { background: #95a5a6; color: white; }/* å·²å‘è½¦è¶…è¿‡3åˆ†é’Ÿçš„åˆ—è½¦åŠ¨ç”» */
        .train-item.fade-out {
            animation: fadeOutSmooth 1.5s ease forwards;
            pointer-events: none !important;
        }
        /* åˆ—è½¦æ¶ˆå¤±è¡¥å……åŠ¨ç”» */
        @keyframes fadeOutSmooth {
            0% { 
                opacity: 0.7; 
                transform: translateX(0) scale(1);
            }
            100% { 
                opacity: 0; 
                transform: translateX(-20px) scale(0.95);
            }
        }


        /* å…¶ä»–åˆ—è½¦ä¸Šç§»è¡¥å……åŠ¨ç”» */
        .train-item.slide-up {
            animation: slideUpSmooth 1.5s ease forwards;
            pointer-events: none !important;
        }

        @keyframes slideUpSmooth {
            0% { 
                transform: translateY(0px);
            }
            100% { 
                transform: translateY(-110%);
            }
        }        /* æ·¡å‡ºå‰çš„é¢„è­¦çŠ¶æ€ */
        .train-item.pre-fade {
            opacity: 0.7;
            transition: opacity 1s ease;
        }

        .route-map {
            background: #16213e;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .route-title {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 30px;
            color: #ffd700;
        }

        .route-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .route-line {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .route-line-title {
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }        .express-title {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .super-express-title {
            background: linear-gradient(135deg, #8e44ad, #6c3483);
            color: white;
            position: relative;
        }

        .super-express-title::before {
            content: "ç‰¹";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #ffd700;
            color: #8e44ad;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .regular-title {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .stations-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .station {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 100px;
        }

        .station-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-bottom: 8px;
            border: 2px solid #34495e;
            position: relative;
        }

        .station-circle.stop {
            background: #ffd700;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .station-circle.pass {
            background: transparent;
            border-color: #34495e;
        }

        .station-name-map {
            font-size: 12px;
            text-align: center;
            color: #bdc3c7;
            line-height: 1.2;
        }

        .route-line-track {
            height: 2px;
            background: linear-gradient(90deg, #34495e 0%, #2c3e50 50%, #34495e 100%);
            position: relative;
            margin: 8px 0;
        }

        .next-departure-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #ffd700;
            color: #1a1a2e;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            animation: blink 1.5s infinite;
        }        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }        /* æ­£åœ¨æ£€ç¥¨çš„ç¼“æ…¢å‘¼å¸ç¯æ•ˆæœ - é»„è‰²å’Œæ©™è‰²ä¹‹é—´å˜åŒ– */
        @keyframes slowBreathing {
            0%,20%,80%, 100% { 
                background: #ebbc00;
                box-shadow: 0 0 5px rgba(241, 196, 15, 0.6);
            }
            50% { 
                background: #e67e22;
                box-shadow: 0 0 15px rgba(230, 126, 34, 1);
            }
        }@media (max-width: 768px) {
            .board-header, .train-row {
                grid-template-columns: 50px 80px 70px 100px 50px 70px auto;
                font-size: 11px;
            }
            
            .stations-display {
                min-width: 150px;
                max-width: 250px;
            }
            
            .station-point {
                min-width: 25px;
            }
            
            .station-name-label {
                font-size: 7px;
                width: 25px;
                height: 20px;
            }
            
            .stations-row {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .station {
                min-width: 60px;
            }
        }        @media (max-width: 480px) {
            .stations-display {
                min-width: 120px;
                max-width: 180px;
            }
            
            .station-point {
                min-width: 20px;
            }
            
            .station-name-label {
                font-size: 6px;
                width: 20px;
                height: 18px;
            }
        }        .direction-selector {
            display: flex;
            justify-content: center;
            gap: 0;
            margin: 15px 0;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ffd700;
        }

        .direction-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            flex: 1;
            position: relative;
        }

        .direction-btn:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .direction-btn.active {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4a 100%);
            color: #333;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .direction-btn:first-child {
            border-right: 1px solid rgba(255, 215, 0, 0.3);
        }

        .refresh-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4a 100%);
            color: #333;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #ffed4a 0%, #ffd700 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }        .refresh-btn:disabled {
            background: #95a5a6;
            color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        .refresh-btn:disabled:hover {
            background: #95a5a6;
            transform: none;
            box-shadow: none;
        }.data-source {
            margin-left: 10px;
            font-size: 12px;
            opacity: 0.8;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .data-source-selector {
            display: inline-flex;
            margin-right: 10px;
            border-radius: 5px;
            overflow: hidden;
            border: 2px solid #ffd700;
        }

        .data-source-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
        }

        .data-source-btn:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .data-source-btn.active {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4a 100%);
            color: #333;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .data-source-btn:first-child {
            border-right: 1px solid rgba(255, 215, 0, 0.3);
        }
    </style>
</head>
<body>    <div class="header">
        <div class="current-time" id="currentTime"></div>
        
        <!-- Direction Selector -->
        <div class="direction-selector">
            <button class="direction-btn" id="zhaoqingBtn" onclick="setDirection('zhaoqing')">
                è‚‡åº†æ–¹å‘
            </button>
            <button class="direction-btn active" id="huizhouBtn" onclick="setDirection('huizhou')">
                æƒ å·æ–¹å‘
            </button>
        </div>
        
        <div class="station-input-container" style="position: relative;">
            <input type="text" 
                   class="station-input" 
                   id="currentStationInput" 
                   value="è‚‡åº†ç«™" 
                   placeholder="è¯·è¾“å…¥å½“å‰ç«™ç‚¹åç§°"
                   autocomplete="off">
            <div class="station-suggestions" id="stationSuggestions"></div>
        </div>        <div class="station-name">å‡ºå‘ä¿¡æ¯</div>

        <div style="margin-top: 10px;">            <div class="data-source-selector">
                <button class="data-source-btn active" id="simulationDataBtn" onclick="setDataSource('simulation')">
                    æ¨¡æ‹Ÿæ•°æ®
                </button>
                <button class="data-source-btn" id="api12306DataBtn" onclick="setDataSource('12306')">
                    12306æ•°æ®
                </button>
            </div>
            <button id="refreshDataBtn" onclick="refreshTrainData()" 
                    class="refresh-btn" disabled>
                åˆ·æ–°12306æ•°æ®
            </button>
            <span id="dataSource" class="data-source">æ•°æ®æº: æ¨¡æ‹Ÿæ•°æ®</span>
        </div>
    </div>

    <div class="departure-board">
        <div class="board-header">
            <div>è½¦æ¬¡</div>
            <div>åˆ—è½¦å·</div>
            <div>å‘è½¦æ—¶é—´</div>
            <div>ç»ˆç‚¹ç«™</div>
            <div>ç«™å°</div>
            <div>çŠ¶æ€</div>
            <div>åœé ç«™ç‚¹</div>
        </div>
        <div id="trainList"></div>
    </div>


    <script>        // æ‰€æœ‰ç«™ç‚¹æŒ‰é¡ºåºæ’åˆ—ï¼ˆåŸºäºçœŸå®C7514/C7515åˆ—è½¦æ¡ˆä¾‹ï¼‰
        const allStations = [
            "è‚‡åº†ç«™", "ç«¯å·ç«™", "é¼æ¹–å±±ç«™", "é¼æ¹–ä¸œç«™", "å››ä¼šç«™", "å¤§æ—ºç«™", 
            "äº‘ä¸œæµ·ç«™", "ä¸‰æ°´åŒ—ç«™", "ç‹®å±±åŒ—ç«™", "ç‹®å±±ç«™", "ä½›å±±è¥¿ç«™", "å¼ æ§ç«™", 
            "é¡ºå¾·åŒ—ç«™", "åŒ—æ»˜è¥¿ç«™", "é™ˆæ‘ç«™", "ç•ªç¦ºç«™", "å¹¿å·é•¿éš†ç«™", "ä¸œç¯ç«™", 
            "å®˜æ¡¥åŒ—ç«™", "å¹¿å·è²èŠ±å±±ç«™", "éº»æ¶Œç«™", "ä¸œèè¥¿ç«™", "é“æ»˜ç«™", "è¥¿å¹³è¥¿ç«™", 
            "ä¸œåŸå—ç«™", "å¯®æ­¥ç«™", "æ¾å±±æ¹–åŒ—ç«™", "å¤§æœ—é•‡ç«™", "å¸¸å¹³å—ç«™", "å¸¸å¹³ä¸œç«™", 
            "æ¨Ÿæœ¨å¤´ä¸œç«™", "é“¶ç“¶ç«™", "æ²¥æ—åŒ—ç«™", "é™ˆæ±Ÿå—ç«™", "æƒ ç¯ç«™", "é¾™ä¸°ç«™", 
            "è¥¿æ¹–ä¸œç«™", "äº‘å±±ç«™", "å°é‡‘å£ç«™"
        ];        // å¿«è½¦åœé ç«™ç‚¹ï¼ˆåŸºäºå®é™…å¿«è½¦åœé æ¨¡å¼ï¼‰
        const expressStops = new Set([
            "è‚‡åº†ç«™", "é¼æ¹–ä¸œç«™", "å¤§æ—ºç«™", "ä¸‰æ°´åŒ—ç«™", "ä½›å±±è¥¿ç«™", 
            "ç•ªç¦ºç«™", "å¹¿å·é•¿éš†ç«™", "å¹¿å·è²èŠ±å±±ç«™", "ä¸œèè¥¿ç«™", 
            "è¥¿å¹³è¥¿ç«™", "æ¾å±±æ¹–åŒ—ç«™", "å¸¸å¹³å—ç«™", "é™ˆæ±Ÿå—ç«™", "è¥¿æ¹–ä¸œç«™", 
            "äº‘å±±ç«™", "å°é‡‘å£ç«™"
        ]);        // ç‰¹å¿«åœé ç«™ç‚¹ï¼ˆåœé æ›´å°‘ç«™ç‚¹ï¼‰
        const superExpressStops = new Set([
            "è‚‡åº†ç«™", "ä½›å±±è¥¿ç«™", "ç•ªç¦ºç«™", "è¥¿å¹³è¥¿ç«™", "å°é‡‘å£ç«™"
        ]);

        // æ–¹å‘ç®¡ç†
        let currentDirection = 'huizhou'; // é»˜è®¤æƒ å·æ–¹å‘ï¼ˆåŸå§‹æ•°æ®æ–¹å‘ï¼‰

        // è·å–å½“å‰æ–¹å‘çš„ç«™ç‚¹åˆ—è¡¨
        function getCurrentDirectionStations() {
            if (currentDirection === 'zhaoqing') {
                // è‚‡åº†æ–¹å‘ï¼šåè½¬ç«™ç‚¹é¡ºåº
                return [...allStations].reverse();
            }
            return allStations; // æƒ å·æ–¹å‘ï¼šä¿æŒåŸå§‹é¡ºåº
        }

        // è·å–å½“å‰æ–¹å‘çš„å¿«è½¦åœé ç«™
        function getCurrentDirectionExpressStops() {
            if (currentDirection === 'zhaoqing') {
                // è‚‡åº†æ–¹å‘ï¼šä½¿ç”¨åè½¬çš„ç«™ç‚¹åˆ›å»ºæ–°çš„Set
                const reversedStations = [...allStations].reverse();
                const reversedExpressStops = new Set();
                expressStops.forEach(station => {
                    reversedExpressStops.add(station);
                });
                return reversedExpressStops;
            }
            return expressStops; // æƒ å·æ–¹å‘ï¼šä¿æŒåŸå§‹Set
        }

        // è·å–å½“å‰æ–¹å‘çš„ç‰¹å¿«åœé ç«™
        function getCurrentDirectionSuperExpressStops() {
            if (currentDirection === 'zhaoqing') {
                // è‚‡åº†æ–¹å‘ï¼šä½¿ç”¨åè½¬çš„ç«™ç‚¹åˆ›å»ºæ–°çš„Set
                const reversedStations = [...allStations].reverse();
                const reversedSuperExpressStops = new Set();
                superExpressStops.forEach(station => {
                    reversedSuperExpressStops.add(station);
                });
                return reversedSuperExpressStops;
            }
            return superExpressStops; // æƒ å·æ–¹å‘ï¼šä¿æŒåŸå§‹Set
        }

        // è®¾ç½®æ–¹å‘
        function setDirection(direction) {
            currentDirection = direction;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('huizhouBtn').classList.toggle('active', direction === 'huizhou');
            document.getElementById('zhaoqingBtn').classList.toggle('active', direction === 'zhaoqing');
            
            // // æ›´æ–°å½“å‰ç«™ç‚¹åˆ°æ–°æ–¹å‘çš„é»˜è®¤èµ·å§‹ç«™
            // if (direction === 'zhaoqing') {
            //     // è‚‡åº†æ–¹å‘ï¼šä»å°é‡‘å£ç«™å¼€å§‹
            //     updateCurrentStation('å°é‡‘å£ç«™');
            // } else {
            //     // æƒ å·æ–¹å‘ï¼šä»è‚‡åº†ç«™å¼€å§‹
            //     updateCurrentStation('è‚‡åº†ç«™');
            // }
            
            // é‡æ–°æ¸²æŸ“åˆ—è½¦åˆ—è¡¨
            renderTrainList();
            
            console.log(`æ–¹å‘å·²åˆ‡æ¢ä¸º: ${direction === 'huizhou' ? 'æƒ å·æ–¹å‘' : 'è‚‡åº†æ–¹å‘'}`);
        }// æ»šåŠ¨ç®¡ç†å™¨
        class ScrollManager {
            constructor() {
                this.scrollElements = new Map();
                this.globalScrollTimer = null;
                this.globalPauseTimer = null;
                this.globalResetTimer = null;
                this.isGloballyPaused = false;
                this.hasUserInteraction = false;
                this.finishedScrolls = new Set(); // è®°å½•å·²å®Œæˆæ»šåŠ¨çš„è½¨é“
            }            setupScrolling(trackElement, containerElement) {
                const trackId = trackElement.id;
                
                // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€
                this.clearTrackScrolling(trackId);
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ»šåŠ¨
                const containerWidth = containerElement.offsetWidth;
                const trackWidth = trackElement.scrollWidth;
                const scrollIndicator = containerElement.querySelector('.scroll-indicator');
                
                if (trackWidth <= containerWidth) {
                    scrollIndicator.classList.remove('visible');
                    return;
                }
                
                scrollIndicator.classList.add('visible');
                
                // è®¡ç®—æ»šåŠ¨è·ç¦»å’ŒæŒç»­æ—¶é—´
                const scrollDistance = trackWidth - containerWidth + 80; // é¢å¤–100pxç¡®ä¿å®Œå…¨æ˜¾ç¤º
                const scrollSpeed = 30; // å›ºå®šé€Ÿåº¦ï¼š50åƒç´ /ç§’
                const scrollDuration = scrollDistance / scrollSpeed; // æ ¹æ®è·ç¦»å’Œé€Ÿåº¦è®¡ç®—æ—¶é—´
                
                // è®¾ç½®CSSå˜é‡
                trackElement.style.setProperty('--scroll-distance', `-${scrollDistance}px`);
                trackElement.style.setProperty('--scroll-duration', `${scrollDuration}s`);
                
                // å­˜å‚¨å…ƒç´ ä¿¡æ¯
                this.scrollElements.set(trackId, {
                    trackElement,
                    containerElement,
                    needsScroll: true,
                    duration: scrollDuration,
                    isFinished: false
                });
                
                // æ·»åŠ åŠ¨ç”»ç»“æŸç›‘å¬
                this.addAnimationEndListener(trackElement, trackId);
                
                // æ·»åŠ äº¤äº’äº‹ä»¶
                this.addInteractionEvents(trackElement, containerElement, trackId);
            }            addAnimationEndListener(trackElement, trackId) {
                const onAnimationEnd = (event) => {
                    // ç¡®ä¿æ˜¯è¿™ä¸ªå…ƒç´ è‡ªå·±çš„åŠ¨ç”»ç»“æŸï¼Œä¸æ˜¯å­å…ƒç´ çš„
                    if (event.target !== trackElement) return;
                    
                    console.log(`è½¨é“ ${trackId} æ»šåŠ¨å®Œæˆ`);
                    
                    // åŠ¨ç”»å®Œæˆï¼Œæ ‡è®°ä¸ºå·²å®Œæˆ
                    if (this.scrollElements.has(trackId)) {
                        this.scrollElements.get(trackId).isFinished = true;
                        this.finishedScrolls.add(trackId);
                        
                        // ç§»é™¤æ»šåŠ¨ç±»ï¼Œä½†è®¾ç½®æœ€ç»ˆçš„transformä½ç½®ä»¥ä¿æŒåœ¨ç»“å°¾
                        trackElement.classList.remove('scrolling');
                        const finalPosition = trackElement.style.getPropertyValue('--scroll-distance');
                        trackElement.style.transform = `translateX(${finalPosition})`;
                        
                        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰éœ€è¦æ»šåŠ¨çš„è½¨é“éƒ½å·²å®Œæˆ
                        this.checkAllScrollsFinished();
                    }
                };
                
                trackElement.addEventListener('animationend', onAnimationEnd);
                
                // å­˜å‚¨äº‹ä»¶å¤„ç†å™¨ä»¥ä¾¿åç»­æ¸…ç†
                if (this.scrollElements.has(trackId)) {
                    this.scrollElements.get(trackId).animationHandler = onAnimationEnd;
                }
            }checkAllScrollsFinished() {
                const needsScrollElements = Array.from(this.scrollElements.values())
                    .filter(data => data.needsScroll);
                    
                const finishedCount = needsScrollElements.filter(data => data.isFinished).length;
                const totalCount = needsScrollElements.length;
                
                console.log(`æ»šåŠ¨è¿›åº¦: ${finishedCount}/${totalCount} è½¨é“å·²å®Œæˆ`);
                    
                const allFinished = needsScrollElements.every(data => data.isFinished);
                
                if (allFinished && needsScrollElements.length > 0) {
                    console.log('æ‰€æœ‰è½¨é“æ»šåŠ¨å®Œæˆï¼Œ5ç§’åé‡ç½®');
                    // æ‰€æœ‰è½¨é“éƒ½å®Œæˆäº†æ»šåŠ¨ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡ç½®
                    if (this.globalResetTimer) {
                        clearTimeout(this.globalResetTimer);
                    }
                    
                    this.globalResetTimer = setTimeout(() => {
                        this.resetAllScrollsToStart();
                    }, 5000); // ç­‰å¾…5ç§’åé‡ç½®ï¼Œè®©ç”¨æˆ·æœ‰è¶³å¤Ÿæ—¶é—´æŸ¥çœ‹
                }
            }            resetAllScrollsToStart() {
                if (this.isGloballyPaused) return;
                
                console.log('é‡ç½®æ‰€æœ‰æ»šåŠ¨åˆ°èµ·å§‹ä½ç½®');
                
                // æ·»åŠ é‡ç½®åŠ¨ç”»ç±»ï¼Œå¹³æ»‘è¿‡æ¸¡å›èµ·å§‹ä½ç½®
                this.scrollElements.forEach((data, trackId) => {
                    if (data.needsScroll) {
                        data.trackElement.classList.add('resetting');
                        data.isFinished = false;
                    }
                });
                
                // æ¸…ç©ºå·²å®Œæˆé›†åˆ
                this.finishedScrolls.clear();
                
                // ç­‰å¾…é‡ç½®åŠ¨ç”»å®Œæˆåç§»é™¤è¿‡æ¸¡ç±»å¹¶é‡æ–°å¼€å§‹æ»šåŠ¨
                setTimeout(() => {
                    this.scrollElements.forEach((data, trackId) => {
                        if (data.needsScroll) {
                            data.trackElement.classList.remove('resetting');
                            // æ¸…é™¤ä¹‹å‰è®¾ç½®çš„ transformï¼Œç¡®ä¿å…ƒç´ å›åˆ°èµ·å§‹ä½ç½®
                            data.trackElement.style.transform = 'translateX(0)';
                        }
                    });
                    
                    // é‡æ–°å¼€å§‹æ»šåŠ¨
                    setTimeout(() => {
                        this.startGlobalScrolling();
                    }, 500); // å†ç­‰å¾…0.5ç§’åå¼€å§‹æ–°ä¸€è½®æ»šåŠ¨
                }, 800); // ç­‰å¾…é‡ç½®åŠ¨ç”»å®Œæˆï¼ˆ0.8ç§’ï¼‰
            }startGlobalScrolling() {
                // æ¸…é™¤ä¹‹å‰çš„å…¨å±€è®¡æ—¶å™¨
                if (this.globalScrollTimer) {
                    clearTimeout(this.globalScrollTimer);
                }
                
                console.log('å‡†å¤‡å¼€å§‹å…¨å±€æ»šåŠ¨ï¼Œ2ç§’åå¯åŠ¨');
                
                // å»¶è¿Ÿå¼€å§‹æ‰€æœ‰æ»šåŠ¨
                this.globalScrollTimer = setTimeout(() => {
                    if (!this.isGloballyPaused) {
                        const scrollingTracks = [];
                        this.scrollElements.forEach((data, trackId) => {
                            if (data.needsScroll && !data.isFinished) {
                                data.trackElement.classList.add('scrolling');
                                scrollingTracks.push(`${trackId}(${data.duration.toFixed(1)}s)`);
                            }
                        });
                        console.log('å¼€å§‹æ»šåŠ¨è½¨é“:', scrollingTracks.join(', '));
                    }
                }, 2000);
            }

            pauseAllScrolling() {
                this.isGloballyPaused = true;
                this.hasUserInteraction = true;
                
                // æš‚åœæ‰€æœ‰æ»šåŠ¨
                this.scrollElements.forEach((data) => {
                    data.trackElement.classList.add('paused');
                });
            }

            resumeAllScrolling(delay = 3000) {
                // æ¸…é™¤ä¹‹å‰çš„æ¢å¤è®¡æ—¶å™¨
                if (this.globalPauseTimer) {
                    clearTimeout(this.globalPauseTimer);
                }

                // è®¾ç½®å»¶è¿Ÿæ¢å¤
                this.globalPauseTimer = setTimeout(() => {
                    this.isGloballyPaused = false;
                    this.hasUserInteraction = false;
                    
                    // æ¢å¤æ‰€æœ‰æ»šåŠ¨
                    this.scrollElements.forEach((data) => {
                        data.trackElement.classList.remove('paused');
                    });
                }, delay);
            }            clearTrackScrolling(trackId) {
                if (this.scrollElements.has(trackId)) {
                    const data = this.scrollElements.get(trackId);
                    data.trackElement.classList.remove('scrolling', 'paused', 'resetting');
                    
                    // ç§»é™¤åŠ¨ç”»ç›‘å¬å™¨
                    if (data.animationHandler) {
                        data.trackElement.removeEventListener('animationend', data.animationHandler);
                    }
                    
                    this.scrollElements.delete(trackId);
                    this.finishedScrolls.delete(trackId);
                }
            }

            clearAllScrolling() {
                // æ¸…é™¤æ‰€æœ‰è®¡æ—¶å™¨
                if (this.globalScrollTimer) {
                    clearTimeout(this.globalScrollTimer);
                    this.globalScrollTimer = null;
                }
                
                if (this.globalPauseTimer) {
                    clearTimeout(this.globalPauseTimer);
                    this.globalPauseTimer = null;
                }
                
                if (this.globalResetTimer) {
                    clearTimeout(this.globalResetTimer);
                    this.globalResetTimer = null;
                }                // æ¸…é™¤æ‰€æœ‰æ»šåŠ¨çŠ¶æ€
                this.scrollElements.forEach((data, trackId) => {
                    data.trackElement.classList.remove('scrolling', 'paused', 'resetting');
                    data.trackElement.style.transform = 'translateX(0)';
                    
                    // ç§»é™¤åŠ¨ç”»ç›‘å¬å™¨
                    if (data.animationHandler) {
                        data.trackElement.removeEventListener('animationend', data.animationHandler);
                    }
                });
                
                this.scrollElements.clear();
                this.finishedScrolls.clear();
                this.isGloballyPaused = false;
                this.hasUserInteraction = false;
            }

            addInteractionEvents(trackElement, containerElement, trackId) {
                // é¼ æ ‡äº‹ä»¶ - å½±å“å…¨å±€
                containerElement.addEventListener('mouseenter', () => {
                    this.pauseAllScrolling();
                });
                
                containerElement.addEventListener('mouseleave', () => {
                    this.resumeAllScrolling();
                });
                
                // è§¦æ‘¸äº‹ä»¶ - å½±å“å…¨å±€
                let startX = 0;
                let currentX = 0;
                let isDragging = false;

                containerElement.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    currentX = startX;
                    isDragging = true;
                    this.pauseAllScrolling();
                    e.preventDefault();
                });

                containerElement.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    
                    currentX = e.touches[0].clientX;
                    const deltaX = currentX - startX;
                    
                    // æ‰‹åŠ¨æ»šåŠ¨å½“å‰å…ƒç´ 
                    const currentTransform = trackElement.style.transform.match(/translateX\(([^)]+)\)/);
                    const currentOffset = currentTransform ? parseFloat(currentTransform[1]) : 0;
                    const newOffset = Math.min(0, Math.max(
                        parseFloat(trackElement.style.getPropertyValue('--scroll-distance')), 
                        currentOffset + deltaX
                    ));
                    
                    trackElement.style.transform = `translateX(${newOffset}px)`;
                    startX = currentX;
                    e.preventDefault();
                });

                containerElement.addEventListener('touchend', () => {
                    isDragging = false;
                    this.resumeAllScrolling(5000); // è§¦æ‘¸ç»“æŸå5ç§’æ¢å¤å…¨å±€æ»šåŠ¨
                });
            }
        }

        const scrollManager = new ScrollManager();        // å½“å‰ç«™ç‚¹å˜é‡
        let currentStation = "è‚‡åº†ç«™";
        
        // å½“å‰æ•°æ®æº
        let currentDataSource = 'simulation'; // 'simulation' æˆ– '12306'
        function initializeScrolling() {
            // æ¸…é™¤ä¹‹å‰çš„æ‰€æœ‰æ»šåŠ¨çŠ¶æ€
            scrollManager.clearAllScrolling();

            // ä¸ºæ¯ä¸ªè½¨é“è®¾ç½®æ»šåŠ¨
            trainData.forEach((_, index) => {
                const trackElement = document.getElementById(`track-${index}`);
                const containerElement = document.getElementById(`scroll-container-${index}`);
                
                if (trackElement && containerElement) {
                    scrollManager.setupScrolling(trackElement, containerElement);
                }
            });
            
            // å¯åŠ¨å…¨å±€åŒæ­¥æ»šåŠ¨
            scrollManager.startGlobalScrolling();
        }        // 12306 APIé›†æˆ
        class Railway12306API {            constructor() {
                this.stationCodes = new Map(); // å­˜å‚¨ç«™ç‚¹åç§°åˆ°ä»£ç çš„æ˜ å°„
                this.isInitialized = false; // åˆå§‹åŒ–çŠ¶æ€æ ‡è®°
                this.initializationPromise = null; // åˆå§‹åŒ–Promise
                
                // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œå¼€å‘ç¯å¢ƒä½¿ç”¨localhost
                this.proxyBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                    ? 'http://localhost:3001' 
                    : window.location.origin; // åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å½“å‰åŸŸå
                
                // å¯åŠ¨åˆå§‹åŒ–è¿‡ç¨‹ï¼Œä½†ä¸åœ¨æ„é€ å‡½æ•°ä¸­ç­‰å¾…
                this.initializationPromise = this.initialize();
            }
            
            // åˆå§‹åŒ–æ–¹æ³•ï¼Œç¡®ä¿è½¦ç«™ä»£ç åŠ è½½å®Œæˆ
            async initialize() {
                if (this.isInitialized) {
                    return true;
                }
                
                try {
                    await this.loadStationCodes();
                    this.isInitialized = true;
                    console.log('âœ… Railway12306API åˆå§‹åŒ–å®Œæˆ');
                    return true;
                } catch (error) {
                    console.error('âŒ Railway12306API åˆå§‹åŒ–å¤±è´¥:', error);
                    this.isInitialized = false;
                    throw error;
                }
            }
            
            // ç¡®ä¿å·²åˆå§‹åŒ–çš„æ–¹æ³•
            async ensureInitialized() {
                if (this.isInitialized) {
                    return true;
                }
                
                if (this.initializationPromise) {
                    await this.initializationPromise;
                    return this.isInitialized;
                }
                
                // å¦‚æœæ²¡æœ‰åˆå§‹åŒ–Promiseï¼Œé‡æ–°åˆå§‹åŒ–
                this.initializationPromise = this.initialize();
                await this.initializationPromise;
                return this.isInitialized;
            }

            // åŠ è½½è½¦ç«™ä»£ç ä¿¡æ¯
            async loadStationCodes() {
                try {
                    console.log('å¼€å§‹åŠ è½½è½¦ç«™ä»£ç ...');
                    const response = await fetch(`${this.proxyBaseUrl}/api/station-codes`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const text = await response.text();
                      // è§£æstation_nameså­—ç¬¦ä¸²
                    const match = text.match(/var station_names ='(.+)';/);
                    if (match) {
                        const stationData = match[1];
                        const stations = stationData.split('@').filter(item => item.length > 0);
                        
                        stations.forEach(station => {
                            const parts = station.split('|');
                            if (parts.length >= 3) {
                                const stationName = parts[1]; // ä¸­æ–‡å
                                const stationCode = parts[2]; // è‹±æ–‡ä»£ç 
                                
                                // ä¸ºç«™åæ·»åŠ "ç«™"å­—åç¼€ï¼Œä»¥åŒ¹é…æˆ‘ä»¬çš„ç«™ç‚¹åç§°æ ¼å¼
                                const stationNameWithSuffix = stationName.endsWith('ç«™') ? stationName : stationName + 'ç«™';
                                this.stationCodes.set(stationNameWithSuffix, stationCode);
                                
                                // åŒæ—¶ä¹Ÿä¿å­˜ä¸å¸¦"ç«™"å­—çš„æ˜ å°„ï¼Œä»¥é˜²ä¸‡ä¸€
                                this.stationCodes.set(stationName, stationCode);
                            }
                        });
                        
                        console.log('è½¦ç«™ä»£ç åŠ è½½å®Œæˆï¼Œå…±', this.stationCodes.size, 'ä¸ªè½¦ç«™');                    } else {
                        throw new Error('æ— æ³•è§£æè½¦ç«™ä»£ç æ•°æ®');
                    }
                } catch (error) {
                    console.error('åŠ è½½è½¦ç«™ä»£ç å¤±è´¥:', error);
                    throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œå¼ºåˆ¶å¤±è´¥
                }            }            // è·å–è½¦ç«™ä»£ç 
            getStationCode(stationName) {
                // æ£€æŸ¥è½¦ç«™ä»£ç æ˜¯å¦å·²åŠ è½½
                if (this.stationCodes.size === 0) {
                    throw new Error('è½¦ç«™ä»£ç å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç­‰å¾…ç½‘ç»œåŠ è½½æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
                
                // é¦–å…ˆå°è¯•ç›´æ¥æŸ¥æ‰¾
                if (this.stationCodes.has(stationName)) {
                    return this.stationCodes.get(stationName);
                }
                
                // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•æ·»åŠ æˆ–ç§»é™¤"ç«™"å­—
                if (stationName.endsWith('ç«™')) {
                    // å¦‚æœå¸¦"ç«™"å­—ï¼Œå°è¯•ä¸å¸¦"ç«™"å­—çš„ç‰ˆæœ¬
                    const nameWithoutSuffix = stationName.slice(0, -1);
                    if (this.stationCodes.has(nameWithoutSuffix)) {
                        return this.stationCodes.get(nameWithoutSuffix);
                    }
                } else {
                    // å¦‚æœä¸å¸¦"ç«™"å­—ï¼Œå°è¯•å¸¦"ç«™"å­—çš„ç‰ˆæœ¬
                    const nameWithSuffix = stationName + 'ç«™';
                    if (this.stationCodes.has(nameWithSuffix)) {
                        return this.stationCodes.get(nameWithSuffix);
                    }
                }
                
                console.warn(`æœªæ‰¾åˆ°è½¦ç«™ä»£ç : ${stationName}ï¼Œå¯ç”¨è½¦ç«™ä»£ç æ•°é‡: ${this.stationCodes.size}`);
                return null;
            }            // æŸ¥è¯¢åˆ—è½¦ä½™ç¥¨ä¿¡æ¯            
            async queryTrains(fromStation, toStation, date) {
                // ç¡®ä¿å·²åˆå§‹åŒ–
                await this.ensureInitialized();
                
                const fromCode = this.getStationCode(fromStation);
                const toCode = this.getStationCode(toStation);
                
                if (!fromCode || !toCode) {
                    const errorMsg = `æœªæ‰¾åˆ°è½¦ç«™ä»£ç : ${fromStation}(${fromCode}) -> ${toStation}(${toCode})ï¼Œè¯·ç¡®ä¿è½¦ç«™ä»£ç å·²ä»åœ¨çº¿è·å–`;
                    console.error(errorMsg);
                    throw new Error(errorMsg);
                }
                
                try {
                    console.log(`æŸ¥è¯¢åˆ—è½¦: ${fromStation}(${fromCode}) -> ${toStation}(${toCode}) æ—¥æœŸ: ${date}`);
                    
                    const url = `${this.proxyBaseUrl}/api/query-trains`;
                    const params = new URLSearchParams({
                        from_station: fromCode,
                        to_station: toCode,
                        train_date: date
                    });
                    
                    const response = await fetch(`${url}?${params}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                      if (data.data && data.data.result) {
                        const trains = this.parseTrainResults(data.data.result);
                        console.log(`ğŸš† æŸ¥è¯¢åˆ°${trains.length}è¶Ÿåˆ—è½¦ (${fromStation} â†’ ${toStation})`);
                        return trains;
                    }
                    console.warn('âš ï¸ æœªè·å–åˆ°åˆ—è½¦æ•°æ®');
                    return [];
                } catch (error) {
                    console.error('æŸ¥è¯¢åˆ—è½¦ä¿¡æ¯å¤±è´¥:', error);
                    return [];
                }
            }

            // è§£æåˆ—è½¦æŸ¥è¯¢ç»“æœ
            parseTrainResults(results) {
                return results.map(result => {
                    const parts = result.split('|');
                    if (parts.length >= 35) {
                        return {
                            trainNo: parts[2], // åˆ—è½¦å·ç¼–ç 
                            trainCode: parts[3], // è½¦æ¬¡
                            fromStation: parts[4],
                            toStation: parts[5],
                            fromStationName: parts[6],
                            toStationName: parts[7],
                            startTime: parts[8],
                            arriveTime: parts[9],
                            duration: parts[10]
                        };
                    }
                    return null;
                }).filter(train => train !== null);
            }            // æŸ¥è¯¢åˆ—è½¦è¯¦ç»†ä¿¡æ¯
            async queryTrainDetails(trainNo, fromCode, toCode, date) {
                // ç¡®ä¿å·²åˆå§‹åŒ–
                await this.ensureInitialized();
                
                try {
                    console.log(`æŸ¥è¯¢åˆ—è½¦è¯¦ç»†ä¿¡æ¯: ${trainNo}`);
                    
                    const url = `${this.proxyBaseUrl}/api/train-details`;
                    const params = new URLSearchParams({
                        train_no: trainNo,
                        from_station_telecode: fromCode,
                        to_station_telecode: toCode,
                        depart_date: date
                    });
                    
                    const response = await fetch(`${url}?${params}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();                    if (data.data && data.data.data) {
                        // æ£€æŸ¥åˆ—è½¦æ˜¯å¦åŒ…å«"ä½›å±±è¥¿"ç«™ç‚¹ï¼ˆä¸å«ç©ºæ ¼ï¼‰ï¼Œå¦‚æœåŒ…å«åˆ™è¯´æ˜æ˜¯å…¶ä»–çº¿è·¯çš„åˆ—è½¦ï¼Œç›´æ¥è¿‡æ»¤æ‰
                        const stationNames = data.data.data.map(station => station.station_name);
                        const hasFoshanXi = stationNames.some(name => {
                            if (!name) return false;
                            // åªæ£€æŸ¥ä¸å«ç©ºæ ¼çš„"ä½›å±±è¥¿"ï¼Œå«ç©ºæ ¼çš„"ä½›å±± è¥¿"ä¸è¿‡æ»¤
                            return name === 'ä½›å±±è¥¿' || name === 'ä½›å±±è¥¿ç«™';
                        });
                        
                        if (hasFoshanXi) {
                            console.log(`ğŸš« åˆ—è½¦${trainNo}åŒ…å«ä½›å±±è¥¿ç«™ç‚¹ï¼Œåˆ¤å®šä¸ºå…¶ä»–çº¿è·¯åˆ—è½¦ï¼Œå®Œå…¨è¿‡æ»¤æ‰`);
                            console.log('ğŸ“ è¯¥åˆ—è½¦åœé ç«™ç‚¹:', stationNames.join(' â†’ '));
                            return null; // è¿”å›nullè¡¨ç¤ºè¯¥åˆ—è½¦åº”è¢«è¿‡æ»¤æ‰
                        }
                        
                        console.log(`âœ… åˆ—è½¦${trainNo}é€šè¿‡è¿‡æ»¤æ£€æŸ¥ï¼ŒåŒ…å«${data.data.data.length}ä¸ªç«™ç‚¹`);
                        return data.data.data;
                    }
                    return [];
                } catch (error) {
                    console.error('æŸ¥è¯¢åˆ—è½¦è¯¦ç»†ä¿¡æ¯å¤±è´¥:', error);
                    return [];
                }            }// åˆ¤æ–­åˆ—è½¦ç±»å‹
            determineTrainType(trainCode, stations) {
                // æ ¹æ®è½¦æ¬¡å·åˆ¤æ–­åˆ—è½¦ç±»å‹
                // æå–è½¦æ¬¡å·ä¸­çš„æ•°å­—éƒ¨åˆ†
                const trainNumber = trainCode.replace(/[^0-9]/g, '');
                const trainNum = parseInt(trainNumber);
                
                if (trainNum >= 6880 && trainNum <= 6899) {
                    return 'ç‰¹å¿«';
                } else if (trainNumber.startsWith('68')) {
                    return 'å¿«è½¦';
                } else {
                    return 'æ™®é€š';
                }
            }
        }        // åˆå§‹åŒ–12306 API
        const railway12306 = new Railway12306API();

        // æ ¹æ®è½¦æ¬¡å·åˆ¤æ–­åˆ—è½¦ç±»å‹çš„é€šç”¨å‡½æ•°
        function getTrainTypeByNumber(trainNumber) {
            if (!trainNumber) return 'æ™®é€š';
            
            // æå–è½¦æ¬¡å·ä¸­çš„æ•°å­—éƒ¨åˆ†
            const numberOnly = trainNumber.replace(/[^0-9]/g, '');
            const trainNum = parseInt(numberOnly);
            
            if (trainNum >= 6880 && trainNum <= 6899) {
                return 'ç‰¹å¿«';
            } else if (numberOnly.startsWith('68')) {
                return 'å¿«è½¦';
            } else {
                return 'æ™®é€š';
            }
        }        // æ¨¡æ‹Ÿæ•°æ®
        const simulationTrainData = [
            {
                type: "æ™®é€š",
                number: "C7500",
                time: (() => {
                    // ç”Ÿæˆå¦ä¸€ä¸ªå·²å‘è½¦è¶…è¿‡3åˆ†é’Ÿçš„æ—¶é—´ï¼ˆæ¯”å½“å‰æ—¶é—´æ—©4åˆ†é’Ÿï¼‰
                    const now = new Date();
                    const pastTime = new Date(now.getTime() - 4 * 60000);
                    return `${pastTime.getHours().toString().padStart(2, '0')}:${pastTime.getMinutes().toString().padStart(2, '0')}`;
                })(),
                destination: "æƒ ç¯ç«™",
                platform: "1",
                status: "å·²å‘è½¦",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "æ™®é€š",
                number: "C7501",
                time: (() => {
                    // ç”Ÿæˆä¸€ä¸ªå³å°†å‘è½¦çš„æ—¶é—´ï¼ˆæ¯”å½“å‰æ—¶é—´æ™š2åˆ†é’Ÿï¼‰
                    const now = new Date();
                    const soonTime = new Date(now.getTime() + 2 * 60000);
                    return `${soonTime.getHours().toString().padStart(2, '0')}:${soonTime.getMinutes().toString().padStart(2, '0')}`;
                })(),
                destination: "å°é‡‘å£ç«™",
                platform: "2",
                status: "å³å°†å‘è½¦",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "ç‰¹å¿«",
                number: "C6881",
                time: (() => {
                    // ç”Ÿæˆä¸€ä¸ªæ­£åœ¨æ£€ç¥¨çš„æ—¶é—´ï¼ˆæ¯”å½“å‰æ—¶é—´æ™š8åˆ†é’Ÿï¼‰
                    const now = new Date();
                    const checkTime = new Date(now.getTime() + 8 * 60000);
                    return `${checkTime.getHours().toString().padStart(2, '0')}:${checkTime.getMinutes().toString().padStart(2, '0')}`;
                })(),
                destination: "è¥¿å¹³è¥¿ç«™",
                platform: "1",
                status: "æ­£åœ¨æ£€ç¥¨",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "å¿«è½¦",
                number: "C6802",
                time: "18:05",
                destination: "ä¸œèè¥¿ç«™",
                platform: "4",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "æ™®é€š",
                number: "C7502",
                time: "18:15",
                destination: "æƒ ç¯ç«™",
                platform: "1",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "ç‰¹å¿«",
                number: "C6882",
                time: "18:20",
                destination: "å°é‡‘å£ç«™",
                platform: "3",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "å¿«è½¦",
                number: "C6803",
                time: "18:25",
                destination: "æ¾å±±æ¹–åŒ—ç«™",
                platform: "3",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "æ™®é€š",
                number: "C7503",
                time: "18:38",
                destination: "é¾™ä¸°ç«™",
                platform: "2",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "ç‰¹å¿«",
                number: "C6883",
                time: "18:45",
                destination: "ä½›å±±è¥¿ç«™",
                platform: "4",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "å¿«è½¦",
                number: "C6804",
                time: "18:50",
                destination: "å¸¸å¹³å—ç«™",
                platform: "4",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "æ™®é€š",
                number: "C7504",
                time: "19:05",
                destination: "é™ˆæ±Ÿå—ç«™",
                platform: "1",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "å¿«è½¦",
                number: "C6805",
                time: "19:12",
                destination: "å¹¿å·è²èŠ±å±±ç«™",
                platform: "2",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "æ™®é€š",
                number: "C7505",
                time: "19:25",
                destination: "è¥¿æ¹–ä¸œç«™",
                platform: "3",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "ç‰¹å¿«",
                number: "C6884",
                time: "19:30",
                destination: "ç•ªç¦ºç«™",
                platform: "1",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            },
            {
                type: "å¿«è½¦",
                number: "C6806",
                time: "19:45",
                destination: "ä¸‰æ°´åŒ—ç«™",
                platform: "4",
                status: "å‡†ç‚¹",
                note: "1-8å·è½¦å¢"
            }
        ];

        // åˆ—è½¦æ•°æ®ï¼ˆæ ¹æ®å½“å‰æ•°æ®æºä½¿ç”¨12306æ•°æ®æˆ–æ¨¡æ‹Ÿæ•°æ®ï¼‰
        let trainData = [...simulationTrainData]; // é»˜è®¤ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            document.getElementById('currentTime').textContent = `${dateString} ${timeString}`;        }        // æ ¹æ®å½“å‰æ—¶é—´å’Œå‘è½¦æ—¶é—´è®¡ç®—åˆ—è½¦çŠ¶æ€
        function calculateTrainStatus(departureTime) {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // è§£æå‘è½¦æ—¶é—´
            const [hours, minutes] = departureTime.split(':').map(Number);
            const departMinutes = hours * 60 + minutes;
            
            // è®¡ç®—æ—¶é—´å·®ï¼ˆåˆ†é’Ÿï¼‰
            const timeDiff = departMinutes - currentMinutes;
            
            if (timeDiff <= -3) {
                // å·²å‘è½¦è¶…è¿‡3åˆ†é’Ÿï¼Œå‡†å¤‡æ·¡å‡º
                return { status: 'å·²å‘è½¦', class: 'departed', shouldFadeOut: true };
            } else if (timeDiff <= 0) {
                // å·²ç»å‘è½¦ä½†æœªè¶…è¿‡3åˆ†é’Ÿ
                return { status: 'å·²å‘è½¦', class: 'departed', shouldFadeOut: false };            } else if (timeDiff <= 4) {
                // 4åˆ†é’Ÿå†…å³å°†å‘è½¦
                return { status: 'å³å°†å‘è½¦', class: 'boarding boarding-soon', shouldFadeOut: false };
            } else if (timeDiff <= 15) {
                // 15åˆ†é’Ÿå†…å¼€å§‹æ£€ç¥¨
                return { status: 'æ­£åœ¨æ£€ç¥¨', class: 'boarding', shouldFadeOut: false };
            } else {
                // æ­£å¸¸çŠ¶æ€
                return { status: 'å‡†ç‚¹', class: 'on-time', shouldFadeOut: false };
            }
        }        // æ™ºèƒ½çŠ¶æ€åˆ·æ–° - æ ¹æ®å³å°†å‘ç”Ÿçš„çŠ¶æ€å˜åŒ–å†³å®šåˆ·æ–°é¢‘ç‡
        function scheduleSmartStatusRefresh() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // æ‰¾åˆ°æœ€è¿‘éœ€è¦çŠ¶æ€æ›´æ–°çš„åˆ—è½¦
            let nearestStatusChange = null;
            let minTimeDiff = Infinity;
            
            trainData.forEach(train => {
                const [hours, minutes] = train.time.split(':').map(Number);
                const trainMinutes = hours * 60 + minutes;
                const timeDiff = trainMinutes - currentMinutes;
                
                // æ£€æŸ¥å„ä¸ªçŠ¶æ€è½¬æ¢çš„ä¸´ç•Œç‚¹
                const statusChangePoints = [
                    timeDiff - 15, // å¼€å§‹æ£€ç¥¨
                    timeDiff - 4,  // å³å°†å‘è½¦
                    timeDiff,      // å·²å‘è½¦
                    timeDiff + 3   // å‘è½¦å3åˆ†é’Ÿï¼ˆæ·¡å‡ºæ—¶æœºï¼‰
                ].filter(diff => diff > 0 && diff < minTimeDiff);
                
                if (statusChangePoints.length > 0) {
                    const nearestChange = Math.min(...statusChangePoints);
                    if (nearestChange < minTimeDiff) {
                        minTimeDiff = nearestChange;
                        nearestStatusChange = nearestChange;
                    }
                }
            });
            
            // æ ¹æ®æœ€è¿‘çš„çŠ¶æ€å˜åŒ–è®¾ç½®åˆ·æ–°é—´éš”
            let refreshInterval;
            if (nearestStatusChange !== null && nearestStatusChange <= 20) {
                // å¦‚æœ20åˆ†é’Ÿå†…æœ‰çŠ¶æ€å˜åŒ–ï¼Œæ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
                refreshInterval = 60000; // 1åˆ†é’Ÿ
                console.log(`â° æ™ºèƒ½åˆ·æ–°ï¼š${Math.ceil(nearestStatusChange)}åˆ†é’Ÿåæœ‰çŠ¶æ€å˜åŒ–ï¼Œæ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡`);
            } else {
                // å¦åˆ™æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
                refreshInterval = 300000; // 5åˆ†é’Ÿ
                console.log('â° æ™ºèƒ½åˆ·æ–°ï¼šæ— è¿‘æœŸçŠ¶æ€å˜åŒ–ï¼Œæ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡');
            }
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (window.statusRefreshTimer) {
                clearTimeout(window.statusRefreshTimer);
            }
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨
            window.statusRefreshTimer = setTimeout(() => {
                console.log('ğŸ”„ æ™ºèƒ½åˆ·æ–°åˆ—è½¦çŠ¶æ€...');
                renderTrainList();
                scheduleSmartStatusRefresh(); // é€’å½’å®‰æ’ä¸‹æ¬¡åˆ·æ–°
            }, refreshInterval);
        }        // ç®¡ç†åˆ—è½¦çš„æ·¡å‡ºå’Œç§»é™¤
        function manageFadeOutTrains() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // æ ‡è®°éœ€è¦æ·¡å‡ºçš„åˆ—è½¦
            const trainsToFadeOut = [];
            trainData.forEach((train, index) => {
                const [hours, minutes] = train.time.split(':').map(Number);
                const trainMinutes = hours * 60 + minutes;
                const timeDiff = trainMinutes - currentMinutes;
                
                if (timeDiff <= -3) {
                    trainsToFadeOut.push(index);
                }
            });            if (trainsToFadeOut.length > 0) {
                console.log(`ğŸš« æ·¡å‡º${trainsToFadeOut.length}è¶Ÿå·²å‘è½¦è¶…è¿‡3åˆ†é’Ÿçš„åˆ—è½¦`);
                
                // å…ˆå¼€å§‹æ·¡å‡ºåŠ¨ç”»
                trainsToFadeOut.forEach(index => {
                    const trainElement = document.querySelector(`[data-train-index="${index}"]`);
                    if (trainElement && !trainElement.classList.contains('fade-out')) {
                        trainElement.classList.add('fade-out');
                    }
                });
                
                // 2ç§’åï¼ˆæ·¡å‡ºåŠ¨ç”»å®Œæˆï¼‰å¼€å§‹å…¶ä»–åˆ—è½¦çš„ä¸Šç§»åŠ¨ç”»
                setTimeout(() => {
                    // ä¸ºå…¶ä»–åˆ—è½¦æ·»åŠ ä¸Šç§»åŠ¨ç”»
                    const allTrainElements = document.querySelectorAll('.train-item:not(.fade-out)');
                    allTrainElements.forEach(element => {
                        if (!element.classList.contains('slide-up')) {
                            element.classList.add('slide-up');
                        }
                    });
                }, 1000);
                
                // 2.5ç§’åä»æ•°æ®ä¸­ç§»é™¤å·²æ·¡å‡ºçš„åˆ—è½¦ï¼Œå¹¶é‡æ–°æ¸²æŸ“
                setTimeout(() => {
                    // ä»åå¾€å‰åˆ é™¤ï¼Œé¿å…ç´¢å¼•å˜åŒ–
                    for (let i = trainsToFadeOut.length - 1; i >= 0; i--) {
                        trainData.splice(trainsToFadeOut[i], 1);
                    }
                    console.log(`âœ… ç§»é™¤äº†${trainsToFadeOut.length}è¶Ÿåˆ—è½¦ï¼Œå½“å‰åˆ—è½¦æ•°é‡ï¼š${trainData.length}`);
                    renderTrainList();
                }, 3000);
            }
        }

        function getNextDeparture() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // æŸ¥æ‰¾çœŸæ­£"å³å°†å‘è½¦"çŠ¶æ€çš„åˆ—è½¦ï¼ˆ4åˆ†é’Ÿå†…å‘è½¦ï¼‰
            for (let train of trainData) {
                const [hours, minutes] = train.time.split(':').map(Number);
                const trainMinutes = hours * 60 + minutes;
                const timeDiff = trainMinutes - currentMinutes;
                
                // åªæœ‰åœ¨4åˆ†é’Ÿå†…å³å°†å‘è½¦çš„åˆ—è½¦æ‰è¢«æ ‡è®°ä¸º"å³å°†å‘è½¦"
                if (timeDiff > 0 && timeDiff <= 4) {
                    return train.number;
                }
            }
            
            // å¦‚æœæ²¡æœ‰å³å°†å‘è½¦çš„åˆ—è½¦ï¼Œè¿”å›nullï¼ˆä¸é«˜äº®ä»»ä½•åˆ—è½¦ï¼‰
            return null;
        }        function renderStationsDisplay(train, index, isPassing = false) {
            // å¦‚æœæ˜¯é€šè¿‡çŠ¶æ€ï¼Œè¿”å›ç®€åŒ–çš„æ˜¾ç¤º
            if (isPassing) {
                return `
                    <div class="stations-display passing-display">
                        <div class="not-stopping-message">åˆ—è½¦ä¸åœé æœ¬ç«™</div>
                    </div>
                `;
            }
              // æ ¹æ®è½¦æ¬¡å·åŠ¨æ€åˆ¤æ–­åˆ—è½¦ç±»å‹
            const actualType = getTrainTypeByNumber(train.number);
            const isExpress = actualType === 'å¿«è½¦';
            const isSuperExpress = actualType === 'ç‰¹å¿«';
            
            // ä½¿ç”¨å½“å‰æ–¹å‘çš„ç«™ç‚¹åˆ—è¡¨
            const currentDirectionStations = getCurrentDirectionStations();
            
            // åœ¨æŸ¥æ‰¾ç»ˆç‚¹ç«™ç´¢å¼•æ—¶ï¼Œå»é™¤å¯èƒ½å­˜åœ¨çš„ç©ºæ ¼ä»¥ä¾¿æ­£ç¡®åŒ¹é…
            let destinationIndex = -1;
            if (train.destination) {
                // å…ˆå°è¯•ç›´æ¥åŒ¹é…
                destinationIndex = currentDirectionStations.indexOf(train.destination);
                
                // å¦‚æœç›´æ¥åŒ¹é…å¤±è´¥ï¼Œå°è¯•å»é™¤ç©ºæ ¼ååŒ¹é…
                if (destinationIndex === -1) {
                    const normalizedDestination = train.destination.replace(/\s+/g, '');
                    destinationIndex = currentDirectionStations.findIndex(station => 
                        station.replace(/\s+/g, '') === normalizedDestination
                    );
                }
            }
            
            const currentStationIndex = currentDirectionStations.indexOf(currentStation);
            
            // ä¿®æ”¹æ˜¾ç¤ºé€»è¾‘ï¼šä»å½“å‰ç«™å¼€å§‹æ˜¾ç¤ºåˆ°ç»ˆç‚¹ç«™
            let stationsToShow;
            if (destinationIndex === -1) {
                // å¦‚æœæ‰¾ä¸åˆ°ç»ˆç‚¹ç«™ï¼Œä»å½“å‰ç«™æ˜¾ç¤ºæ‰€æœ‰åç»­ç«™ç‚¹
                stationsToShow = currentDirectionStations.slice(currentStationIndex);
            } else {
                // ä»å½“å‰ç«™æ˜¾ç¤ºåˆ°ç»ˆç‚¹ç«™
                stationsToShow = currentDirectionStations.slice(currentStationIndex, destinationIndex + 1);
            }              const stationPoints = stationsToShow.map((station, stationIndex) => {
                const globalStationIndex = currentDirectionStations.indexOf(station);
                let dotClass = 'station-dot';
                let nameClass = 'station-name-label';
                  // åˆ¤æ–­ç«™ç‚¹çŠ¶æ€
                if (station === currentStation) {
                    dotClass += ' current';
                    nameClass += ' highlight';
                } else {
                    // ç”±äºç°åœ¨åªæ˜¾ç¤ºä»å½“å‰ç«™å¼€å§‹çš„ç«™ç‚¹ï¼Œä¸ä¼šæœ‰å·²è¿‡ç«™çš„æƒ…å†µ
                    // æ ¹æ®åˆ—è½¦ç±»å‹åˆ¤æ–­æ˜¯å¦åœé 
                    const currentExpressStops = getCurrentDirectionExpressStops();
                    const currentSuperExpressStops = getCurrentDirectionSuperExpressStops();
                    
                    if (isSuperExpress && currentSuperExpressStops.has(station)) {
                        dotClass += ' stop';
                        nameClass += ' highlight';
                    } else if (isExpress && !isSuperExpress && currentExpressStops.has(station)) {
                        dotClass += ' stop';
                        nameClass += ' highlight';
                    } else if (!isExpress && !isSuperExpress) {
                        // æ™®é€šåˆ—è½¦åœé æ‰€æœ‰ç«™ç‚¹
                        dotClass += ' stop';
                        nameClass += ' highlight';
                    }
                }
                
                return `
                    <div class="station-point">
                        <div class="${dotClass}"></div>
                        <div class="${nameClass}">${station.replace('ç«™', '')}</div>
                    </div>
                `;
            }).join('');            const trainTypeText = isSuperExpress ? 'ç‰¹å¿«' : (isExpress ? 'å¿«è½¦' : 'æ™®é€š');
            
            // ä½¿ç”¨å½“å‰æ–¹å‘çš„åœé ç«™è®¡ç®—
            const currentExpressStops = getCurrentDirectionExpressStops();
            const currentSuperExpressStops = getCurrentDirectionSuperExpressStops();
            
            const stopsCount = isSuperExpress ? 
                stationsToShow.filter(s => currentSuperExpressStops.has(s)).length : 
                (isExpress ? 
                    stationsToShow.filter(s => currentExpressStops.has(s)).length : 
                    stationsToShow.length);
            
            const trackId = `track-${index}`;
            const scrollContainerId = `scroll-container-${index}`;            // è®¡ç®—è½¨é“çº¿çš„å®é™…å®½åº¦ï¼šç«™ç‚¹æ•°é‡ * ç«™ç‚¹æœ€å°å®½åº¦ - ä¸€ä¸ªç«™ç‚¹å®½åº¦ï¼ˆå› ä¸ºæ˜¯ä»ç¬¬ä¸€ä¸ªç«™ç‚¹ä¸­å¿ƒå¼€å§‹ï¼‰
            const trackLineWidth = (stationsToShow.length - 1) * 42; // 40pxæœ€å°å®½åº¦ + 2pxé—´éš™
              return `
                <div class="stations-display">
                    <div class="stations-scroll-container" id="${scrollContainerId}">
                        <div class="stations-track" id="${trackId}">
                            <div class="track-line" style="width: ${trackLineWidth}px;"></div>
                            ${stationPoints}
                        </div>
                        <div class="scroll-indicator"></div>
                    </div>
                    <div class="stations-info">${trainTypeText} | ${stopsCount}ç«™</div>
                </div>
            `;}        function renderTrainList() {
            const trainListElement = document.getElementById('trainList');
            
            trainListElement.innerHTML = trainData.map((train, index) => {
                // æ ¹æ®è½¦æ¬¡å·åŠ¨æ€åˆ¤æ–­åˆ—è½¦ç±»å‹
                const actualType = getTrainTypeByNumber(train.number);
                const typeClass = actualType === 'ç‰¹å¿«' ? 'super-express' : 
                                 (actualType === 'å¿«è½¦' ? 'express' : 'regular');
                
                // æ£€æŸ¥å½“å‰ç«™æ˜¯å¦ä¸ºè¯¥åˆ—è½¦ç§åˆ«åœé ç«™
                const isExpress = actualType === 'å¿«è½¦';
                const isSuperExpress = actualType === 'ç‰¹å¿«';
                let isCurrentStationStop = true;
                
                // ä½¿ç”¨å½“å‰æ–¹å‘çš„åœé ç«™
                const currentExpressStops = getCurrentDirectionExpressStops();
                const currentSuperExpressStops = getCurrentDirectionSuperExpressStops();
                
                if (isSuperExpress && !currentSuperExpressStops.has(currentStation)) {
                    isCurrentStationStop = false;
                } else if (isExpress && !isSuperExpress && !currentExpressStops.has(currentStation)) {
                    isCurrentStationStop = false;
                }
                  // æ ¹æ®æ˜¯å¦åœé ä¿®æ”¹çŠ¶æ€
                let displayStatus, statusClass, shouldFadeOut = false;
                
                if (!isCurrentStationStop) {
                    displayStatus = 'é€šè¿‡';
                    statusClass = 'passing';
                } else {
                    // ä½¿ç”¨æ–°çš„çŠ¶æ€è®¡ç®—å‡½æ•°
                    const statusInfo = calculateTrainStatus(train.time);
                    displayStatus = statusInfo.status;
                    statusClass = statusInfo.class;
                    shouldFadeOut = statusInfo.shouldFadeOut;
                }
                  const stationsDisplay = renderStationsDisplay(train, index, !isCurrentStationStop);

                // ç¡®å®šåˆ—è½¦é¡¹çš„CSSç±»
                let trainItemClasses = 'train-item';
                if (displayStatus === 'å³å°†å‘è½¦') {
                    trainItemClasses += ' next-departure';
                }
                if (!isCurrentStationStop) {
                    trainItemClasses += ' not-stopping';
                }
                if (shouldFadeOut) {
                    trainItemClasses += ' pre-fade';
                }

                return `
                    <div class="${trainItemClasses}" data-train-index="${index}">
                        <div class="train-row">
                            <div class="train-type ${typeClass}">${actualType}</div>
                            <div style="font-weight: bold; color: #fff;">${train.number}</div>
                            <div class="time">${train.time}</div>
                            <div class="destination">${train.destination}</div>                            <div class="platform">${train.platform}</div>
                            <div class="status ${statusClass}">${displayStatus}</div>
                            ${stationsDisplay}
                        </div>
                    </div>
                `;
            }).join('');
              // åˆå§‹åŒ–åŒæ­¥æ»šåŠ¨åŠŸèƒ½
            setTimeout(initializeScrolling, 100);            // æ¸…ç†ä¹‹å‰çš„åŠ¨ç”»ç±»
            setTimeout(() => {
                const slideUpElements = document.querySelectorAll('.train-item.slide-up');
                slideUpElements.forEach(element => {
                    element.classList.remove('slide-up');
                });
            }, 4200); // 2sæ·¡å‡ºç­‰å¾… + 2sä¸Šç§»åŠ¨ç”» + 0.2sç¼“å†²
            
            // å®‰æ’æ™ºèƒ½çŠ¶æ€åˆ·æ–°
            scheduleSmartStatusRefresh();
            
            // ç®¡ç†åˆ—è½¦æ·¡å‡º
            setTimeout(manageFadeOutTrains, 500);
        }// ä»12306è·å–åˆ—è½¦æ•°æ®
        async function fetchTrainData() {
            try {
                // è·å–æœ¬åœ°æ—¶åŒºçš„ä»Šå¤©æ—¥æœŸ YYYY-MM-DD
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                
                // æ‰¾åˆ°å½“å‰ç«™æœ€è¿‘çš„ç‰¹å¿«è½¦åœé ç«™ä½œä¸ºæŸ¥è¯¢ç›®æ ‡
                const nearestSuperExpressStation = findNearestSuperExpressStation(currentStation);
                
                console.log(`æŸ¥è¯¢ä» ${currentStation} åˆ° ${nearestSuperExpressStation} çš„åˆ—è½¦ä¿¡æ¯`);
                
                // å°è¯•ä»12306è·å–æ•°æ®
                const trains = await railway12306.queryTrains(currentStation, nearestSuperExpressStation, todayStr);
                
                if (trains.length > 0) {
                    // å°†12306æ•°æ®è½¬æ¢ä¸ºæˆ‘ä»¬çš„æ ¼å¼
                    const convertedTrains = await Promise.all(trains.map(async (train, index) => {
                        try {
                            const details = await railway12306.queryTrainDetails(
                                train.trainNo, 
                                railway12306.getStationCode(currentStation),
                                railway12306.getStationCode(nearestSuperExpressStation),
                                todayStr
                            );
                            
                            // å¦‚æœqueryTrainDetailsè¿”å›nullï¼Œè¯´æ˜è¯¥åˆ—è½¦è¢«è¿‡æ»¤æ‰äº†ï¼ˆåŒ…å«ä½›å±±è¥¿ç«™ï¼‰
                            if (details === null) {
                                console.log(`ğŸš« åˆ—è½¦${train.trainCode}è¢«è¿‡æ»¤ï¼ˆåŒ…å«ä½›å±±è¥¿ç«™ï¼‰ï¼Œè·³è¿‡è¯¥åˆ—è½¦`);
                                return null;
                            }
                            
                            // å¦‚æœdetailsä¸ºç©ºæ•°ç»„ï¼Œè¯´æ˜APIè°ƒç”¨å¤±è´¥
                            if (!details || details.length === 0) {
                                console.warn(`âš ï¸ åˆ—è½¦${train.trainCode}è¯¦ç»†ä¿¡æ¯è·å–å¤±è´¥ï¼Œè·³è¿‡è¯¥åˆ—è½¦`);
                                return null;
                            }
                            
                            // åˆ¤æ–­åˆ—è½¦ç±»å‹
                            const trainType = railway12306.determineTrainType(train.trainCode, details);
                            
                            // ä»åˆ—è½¦è¯¦æƒ…ä¸­è·å–çœŸæ­£çš„ç»ˆç‚¹ç«™ï¼ˆæœ€åä¸€ä¸ªç«™ç‚¹ï¼‰
                            let actualDestination = nearestSuperExpressStation; // é»˜è®¤å€¼
                            if (details && details.length > 0) {
                                const lastStation = details[details.length - 1];
                                if (lastStation && lastStation.station_name) {
                                    // å»é™¤ç«™ç‚¹åç§°ä¸­çš„ç©ºæ ¼ï¼Œä»¥ä¾¿æ­£ç¡®åŒ¹é…
                                    let stationName = lastStation.station_name.replace(/\s+/g, '');
                                    // ç¡®ä¿ç«™ç‚¹åç§°ä»¥"ç«™"ç»“å°¾
                                    actualDestination = stationName.endsWith('ç«™') ? stationName : stationName + 'ç«™';
                                }
                            }
                            
                            return {
                                type: trainType,
                                number: train.trainCode,
                                time: train.startTime,
                                destination: actualDestination,
                                // platform: (index % 4 + 1).toString(), // æ¨¡æ‹Ÿç«™å°
                                platform: "--", // APIæœªæä¾›ç«™å°ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼ 
                                status: "é»˜è®¤å‡†ç‚¹", // è¿™ä¸ªçŠ¶æ€å°†åœ¨renderTrainListä¸­é‡æ–°è®¡ç®—
                                note: "1-8å·è½¦å¢",
                                trainNo: train.trainNo,
                                details: details
                            };
                        } catch (error) {
                            console.error('è·å–åˆ—è½¦è¯¦ç»†ä¿¡æ¯å¤±è´¥:', error);
                            return null;
                        }
                    }));

                    // è¿‡æ»¤æ‰nullå€¼å¹¶æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
                    const validTrains = convertedTrains.filter(train => train !== null);
                    const filteredCount = convertedTrains.length - validTrains.length;
                    
                    console.log(`ğŸ“Š åˆ—è½¦è¿‡æ»¤ç»Ÿè®¡:`);
                    console.log(`   åŸå§‹æŸ¥è¯¢åˆ°çš„åˆ—è½¦: ${trains.length}`);
                    console.log(`   è½¬æ¢å¤„ç†åæ•°é‡: ${convertedTrains.length}`);
                    console.log(`   è¢«è¿‡æ»¤çš„åˆ—è½¦: ${filteredCount} (åŒ…å«ä½›å±±è¥¿ç«™æˆ–è·å–å¤±è´¥)`);
                    console.log(`   æœ€ç»ˆæœ‰æ•ˆåˆ—è½¦: ${validTrains.length}`);
                    
                    if (validTrains.length > 0) {
                        trainData = validTrains;
                        console.log('âœ… æˆåŠŸè·å–12306æ•°æ®ï¼Œæœ‰æ•ˆåˆ—è½¦æ•°é‡:', trainData.length);
                        return { success: true, data: validTrains, source: '12306' };
                    } else {
                        console.warn('âš ï¸ æ‰€æœ‰åˆ—è½¦éƒ½è¢«è¿‡æ»¤æˆ–æ— æ³•è·å–è¯¦ç»†ä¿¡æ¯');
                        throw new Error('æ‰€æœ‰åˆ—è½¦éƒ½è¢«è¿‡æ»¤æˆ–æ— æ³•è·å–è¯¦ç»†ä¿¡æ¯');
                    }
                } else {
                    console.warn('âš ï¸ 12306 APIè¿”å›ç©ºç»“æœ');
                    throw new Error('12306 APIè¿”å›ç©ºç»“æœ');
                }
                
            } catch (error) {
                console.error('12306 APIè°ƒç”¨å¤±è´¥:', error.message);
                
                // APIå¤±è´¥æ—¶ï¼Œç”ŸæˆåŸºäºå½“å‰æ—¶é—´çš„æ¨¡æ‹Ÿæ•°æ®
                const simulatedData = generateSimulatedTrainData();
                trainData = simulatedData;
                console.log('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œåˆ—è½¦æ•°é‡:', trainData.length);
                
                // è¿”å›å¤±è´¥çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯
                return { 
                    success: false, 
                    data: simulatedData, 
                    source: 'simulation', 
                    error: error.message 
                };
            }
        }// æŸ¥æ‰¾æœ€è¿‘çš„ç‰¹å¿«è½¦åœé ç«™
        function findNearestSuperExpressStation(currentStationName) {
            const currentDirectionStations = getCurrentDirectionStations();
            const currentSuperExpressStops = getCurrentDirectionSuperExpressStops();
            
            const currentIndex = currentDirectionStations.indexOf(currentStationName);
            
            if (currentIndex === -1) {
                // æ ¹æ®æ–¹å‘è¿”å›é»˜è®¤ç»ˆç‚¹
                return currentDirection === 'zhaoqing' ? "è‚‡åº†ç«™" : "å°é‡‘å£ç«™";
            }
            
            // ä»å½“å‰ç«™å‘å‰æ‰¾æœ€è¿‘çš„ç‰¹å¿«è½¦åœé ç«™
            for (let i = currentIndex + 1; i < currentDirectionStations.length; i++) {
                if (currentSuperExpressStops.has(currentDirectionStations[i])) {
                    return currentDirectionStations[i];
                }
            }
            
            // å¦‚æœå‘å‰æ‰¾ä¸åˆ°ï¼Œè¿”å›å¯¹åº”æ–¹å‘çš„æœ€åä¸€ä¸ªç‰¹å¿«è½¦ç«™
            return currentDirection === 'zhaoqing' ? "è‚‡åº†ç«™" : "å°é‡‘å£ç«™";
        }        // ç”ŸæˆåŸºäºå½“å‰æ—¶é—´çš„æ¨¡æ‹Ÿåˆ—è½¦æ•°æ®
        function generateSimulatedTrainData() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const currentDirectionStations = getCurrentDirectionStations();
            const currentStationIndex = currentDirectionStations.indexOf(currentStation);
            
            // ä¸ºä¸åŒåˆ—è½¦ç±»å‹å®šä¹‰å¯èƒ½çš„ç»ˆç‚¹ç«™
            const getDestinationsForTrainType = (trainType, currentIndex) => {
                const currentExpressStops = getCurrentDirectionExpressStops();
                const currentSuperExpressStops = getCurrentDirectionSuperExpressStops();
                
                if (trainType === 'ç‰¹å¿«') {
                    // ç‰¹å¿«åˆ—è½¦åªåˆ°ä¸»è¦ç‰¹å¿«åœé ç«™
                    return Array.from(currentSuperExpressStops).filter(station => {
                        const stationIndex = currentDirectionStations.indexOf(station);
                        return stationIndex > currentIndex;
                    });
                } else if (trainType === 'å¿«è½¦') {
                    // å¿«è½¦åˆ°å¿«è½¦åœé ç«™
                    return Array.from(currentExpressStops).filter(station => {
                        const stationIndex = currentDirectionStations.indexOf(station);
                        return stationIndex > currentIndex;
                    });
                } else {
                    // æ™®é€šåˆ—è½¦å¯ä»¥åˆ°æ‰€æœ‰ç«™ç‚¹
                    return currentDirectionStations.filter(station => {
                        const stationIndex = currentDirectionStations.indexOf(station);
                        return stationIndex > currentIndex;
                    });
                }
            };
            
            // ç”Ÿæˆæ¥ä¸‹æ¥å‡ å°æ—¶çš„åˆ—è½¦ç­æ¬¡
            const simulatedTrains = [];
            
            for (let i = 0; i < 12; i++) {
                let departMinutes, timeString;
                
                // ä¸ºå‰ä¸‰ä¸ªåˆ—è½¦è®¾ç½®ç‰¹å®šçš„æ—¶é—´ï¼Œä»¥ç¡®ä¿æœ‰ä¸åŒçš„çŠ¶æ€
                if (i === 0) {
                    // ç¬¬ä¸€ä¸ªåˆ—è½¦ï¼šå·²å‘è½¦ï¼ˆæ¯”å½“å‰æ—¶é—´æ—©5åˆ†é’Ÿï¼‰
                    departMinutes = currentMinutes - 5;
                } else if (i === 1) {
                    // ç¬¬äºŒä¸ªåˆ—è½¦ï¼šå³å°†å‘è½¦ï¼ˆæ¯”å½“å‰æ—¶é—´æ™š2åˆ†é’Ÿï¼‰
                    departMinutes = currentMinutes + 2;
                } else if (i === 2) {
                    // ç¬¬ä¸‰ä¸ªåˆ—è½¦ï¼šå¼€å§‹æ£€ç¥¨ï¼ˆæ¯”å½“å‰æ—¶é—´æ™š8åˆ†é’Ÿï¼‰
                    departMinutes = currentMinutes + 8;
                } else {
                    // å…¶ä»–åˆ—è½¦ï¼šæ­£å¸¸é—´éš”
                    departMinutes = currentMinutes + 15 + ((i - 3) * 20);
                }
                
                const hours = Math.floor(departMinutes / 60) % 24;
                const minutes = departMinutes % 60;
                timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                
                const trainTypes = ['æ™®é€š', 'å¿«è½¦', 'ç‰¹å¿«'];
                const trainType = trainTypes[i % 3];
                
                // è·å–è¯¥åˆ—è½¦ç±»å‹çš„å¯èƒ½ç»ˆç‚¹ç«™
                const possibleDestinations = getDestinationsForTrainType(trainType, currentStationIndex);
                  // æ ¹æ®åˆ—è½¦ç±»å‹é€‰æ‹©ç»ˆç‚¹ç«™
                let destination;
                if (possibleDestinations.length === 0) {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ç»ˆç‚¹ç«™ï¼Œä½¿ç”¨é»˜è®¤çš„æœ€åä¸€ç«™
                    destination = currentDirection === 'zhaoqing' ? "è‚‡åº†ç«™" : "å°é‡‘å£ç«™";
                } else if (trainType === 'ç‰¹å¿«') {
                    // ç‰¹å¿«åˆ—è½¦å€¾å‘äºé€‰æ‹©æ›´è¿œçš„ç«™ç‚¹
                    const farStations = possibleDestinations.slice(-3); // æœ€å3ä¸ªç«™ç‚¹
                    destination = farStations[i % farStations.length];
                } else if (trainType === 'å¿«è½¦') {
                    // å¿«è½¦é€‰æ‹©ä¸­ç­‰è·ç¦»çš„ç«™ç‚¹
                    const midIndex = Math.floor(possibleDestinations.length / 2);
                    const midStations = possibleDestinations.slice(Math.max(0, midIndex - 2), midIndex + 3);
                    destination = midStations[i % midStations.length];
                } else {
                    // æ™®é€šåˆ—è½¦éšæœºé€‰æ‹©å„ç§è·ç¦»çš„ç«™ç‚¹
                    destination = possibleDestinations[i % possibleDestinations.length];
                }// æ ¹æ®åˆ—è½¦ç±»å‹ç”Ÿæˆè½¦æ¬¡å·
                let trainNumber;
                if (trainType === 'ç‰¹å¿«') {
                    // ç‰¹å¿«: 6880-6899
                    trainNumber = `C${6880 + (i % 20)}`;
                } else if (trainType === 'å¿«è½¦') {
                    // å¿«è½¦: å…¶ä½™68å¼€å¤´ï¼ˆ6800-6870ï¼Œé¿å…æ¥è¿‘ç‰¹å¿«èŒƒå›´ï¼‰
                    trainNumber = `C${6800 + (i % 71)}`;
                } else {
                    // æ™®é€š: é68å¼€å¤´
                    trainNumber = `C${7500 + i}`;
                }
                
                simulatedTrains.push({
                    type: trainType,
                    number: trainNumber,
                    time: timeString,
                    destination: destination,
                    platform: ((i % 4) + 1).toString(),
                    status: "å‡†ç‚¹", // è¿™ä¸ªçŠ¶æ€å°†åœ¨æ¸²æŸ“æ—¶é‡æ–°è®¡ç®—
                    note: "1-8å·è½¦å¢"
                });
            }
            
            return simulatedTrains;
        }        // ç«™ç‚¹è¾“å…¥æ¡†åŠŸèƒ½
        function initStationInput() {
            const stationInput = document.getElementById('currentStationInput');
            const suggestions = document.getElementById('stationSuggestions');
            
            // ç”¨äºé˜²æ­¢ç«æ€æ¡ä»¶çš„å˜é‡
            let isSelectingStation = false;
            
            // è¾“å…¥æ¡†ç„¦ç‚¹å’Œå¤±ç„¦äº‹ä»¶
            stationInput.addEventListener('focus', function() {
                showSuggestions(stationInput.value);
            });
            
            // è¾“å…¥äº‹ä»¶
            stationInput.addEventListener('input', function() {
                const value = this.value.trim();
                showSuggestions(value);
            });
            
            // å¤±ç„¦äº‹ä»¶ï¼ˆå»¶è¿Ÿæ‰§è¡Œä»¥å…è®¸ç‚¹å‡»å»ºè®®é¡¹ï¼‰
            stationInput.addEventListener('blur', function() {
                // å¦‚æœæ­£åœ¨é€‰æ‹©è½¦ç«™ï¼Œåˆ™ä¸æ‰§è¡Œéšè—æ“ä½œ
                if (isSelectingStation) {
                    isSelectingStation = false;
                    return;
                }
                
                setTimeout(() => {
                    if (!isSelectingStation) {
                        suggestions.style.display = 'none';
                    }
                }, 300); // å¢åŠ å»¶è¿Ÿæ—¶é—´åˆ°300ms
            });
              // å›è½¦ç¡®è®¤
            stationInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const value = this.value.trim();
                    const currentStations = getCurrentDirectionStations();
                    if (currentStations.includes(value) || currentStations.includes(value + 'ç«™')) {
                        updateCurrentStation(value.endsWith('ç«™') ? value : value + 'ç«™');
                        suggestions.style.display = 'none';
                        this.blur();
                    }
                }
            });
            
            // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œç‚¹å‡»å¤–éƒ¨æ—¶éšè—å»ºè®®åˆ—è¡¨
            document.addEventListener('click', function(e) {
                if (!stationInput.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
            
            // å°†é˜²ç«æ€æ¡ä»¶å˜é‡å­˜å‚¨åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾›selectStationä½¿ç”¨
            window.stationInputState = { isSelectingStation: () => isSelectingStation, setSelectingStation: (value) => { isSelectingStation = value; } };
        }          function showSuggestions(query) {
            const suggestions = document.getElementById('stationSuggestions');
            const currentStations = getCurrentDirectionStations();
            
            if (!query) {
                // æ˜¾ç¤ºæ‰€æœ‰ç«™ç‚¹ï¼Œä½¿ç”¨mousedownäº‹ä»¶ä»£æ›¿onclickä»¥é¿å…blurå†²çª
                const html = currentStations.map(station => 
                    `<div class="station-suggestion-item" onmousedown="selectStation('${station}')" onclick="event.preventDefault()">${station}</div>`
                ).join('');
                suggestions.innerHTML = html;
                suggestions.style.display = 'block';
                return;
            }
            
            // è¿‡æ»¤åŒ¹é…çš„ç«™ç‚¹
            const filteredStations = currentStations.filter(station => 
                station.includes(query) || station.replace('ç«™', '').includes(query)
            );
            
            if (filteredStations.length > 0) {
                const html = filteredStations.map(station => 
                    `<div class="station-suggestion-item" onmousedown="selectStation('${station}')" onclick="event.preventDefault()">${station}</div>`
                ).join('');
                suggestions.innerHTML = html;
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }
          function selectStation(station) {
            // è®¾ç½®é€‰æ‹©çŠ¶æ€ï¼Œé˜²æ­¢bluräº‹ä»¶å¹²æ‰°
            if (window.stationInputState) {
                window.stationInputState.setSelectingStation(true);
            }
            
            // ç«‹å³éšè—å»ºè®®åˆ—è¡¨
            document.getElementById('stationSuggestions').style.display = 'none';
            
            // æ›´æ–°è½¦ç«™ä¿¡æ¯
            updateCurrentStation(station);
            
            // è®©è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹
            document.getElementById('currentStationInput').blur();
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            setTimeout(() => {
                if (window.stationInputState) {
                    window.stationInputState.setSelectingStation(false);
                }
            }, 100);
        }
          function updateCurrentStation(station) {
            currentStation = station;
            document.getElementById('currentStationInput').value = station;
            // é‡æ–°æ¸²æŸ“åˆ—è½¦åˆ—è¡¨ä»¥æ›´æ–°ç«™ç‚¹çŠ¶æ€
            renderTrainList();
        }        // åˆ·æ–°12306æ•°æ®
        async function refreshTrainData() {
            // åªåœ¨ä½¿ç”¨12306æ•°æ®æºæ—¶å·¥ä½œ
            if (currentDataSource !== '12306') {
                console.log('å½“å‰æ•°æ®æºä¸ºæ¨¡æ‹Ÿæ•°æ®ï¼Œåˆ·æ–°åŠŸèƒ½ä¸å¯ç”¨');
                return;
            }
            
            const refreshBtn = document.getElementById('refreshDataBtn');
            const dataSource = document.getElementById('dataSource');
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'è·å–ä¸­...';
            dataSource.textContent = 'æ•°æ®æº: è·å–ä¸­...';
            
            try {
                const result = await fetchTrainData();
                
                if (result.success) {
                    // APIè°ƒç”¨æˆåŠŸ
                    renderTrainList();
                    dataSource.textContent = 'æ•°æ®æº: 12306 API';
                    console.log('âœ… 12306æ•°æ®åˆ·æ–°æˆåŠŸ');
                } else {
                    // APIè°ƒç”¨å¤±è´¥ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ•°æ®
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('åˆ·æ–°12306æ•°æ®å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                alert('è·å–12306æ•°æ®å¤±è´¥ï¼Œå·²åˆ‡æ¢å›æ¨¡æ‹Ÿæ•°æ®\né”™è¯¯ä¿¡æ¯: ' + error.message);
                
                // åˆ‡æ¢å›æ¨¡æ‹Ÿæ•°æ®
                currentDataSource = 'simulation';
                trainData = [...simulationTrainData];
                
                // æ›´æ–°UIçŠ¶æ€
                document.getElementById('simulationDataBtn').classList.add('active');
                document.getElementById('api12306DataBtn').classList.remove('active');
                dataSource.textContent = 'æ•°æ®æº: æ¨¡æ‹Ÿæ•°æ® (APIå¤±è´¥)';
                
                // é‡æ–°æ¸²æŸ“
                renderTrainList();
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.disabled = currentDataSource !== '12306';
                refreshBtn.textContent = 'åˆ·æ–°12306æ•°æ®';
            }
        }        // åˆå§‹åŒ–å’Œå®šæ—¶æ›´æ–°
        async function init() {
            updateCurrentTime();
            initStationInput();
            
            // é»˜è®¤ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®åˆå§‹åŒ–
            console.log('åˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
            currentDataSource = 'simulation';
            trainData = [...simulationTrainData];
            
            // ç¡®ä¿UIçŠ¶æ€æ­£ç¡®
            document.getElementById('simulationDataBtn').classList.add('active');
            document.getElementById('api12306DataBtn').classList.remove('active');
            document.getElementById('refreshDataBtn').disabled = true;
            document.getElementById('dataSource').textContent = 'æ•°æ®æº: æ¨¡æ‹Ÿæ•°æ®';
            
            renderTrainList();
            
            // æ¯ç§’æ›´æ–°æ—¶é—´æ˜¾ç¤º
            setInterval(updateCurrentTime, 1000);
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°åˆ—è½¦çŠ¶æ€ï¼ˆé‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€ï¼‰
            setInterval(() => {
                console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°åˆ—è½¦çŠ¶æ€...');
                renderTrainList();
            }, 30000);
            
            console.log('ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œé»˜è®¤ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ã€‚åˆ—è½¦çŠ¶æ€å°†æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ã€‚');
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            scrollManager.clearAllScrolling();
        });

        document.addEventListener('DOMContentLoaded', init);        // äº¤äº’æ•ˆæœ
        document.addEventListener('click', function(e) {
            if (e.target.closest('.train-item')) {
                const trainItem = e.target.closest('.train-item');
                trainItem.style.transform = 'scale(1.01)';
                setTimeout(() => {
                    trainItem.style.transform = '';
                }, 200);
            }        });        // è®¾ç½®æ•°æ®æº
        async function setDataSource(source) {
            console.log('åˆ‡æ¢æ•°æ®æºåˆ°:', source);
            
            // æ›´æ–°å½“å‰æ•°æ®æº
            currentDataSource = source;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const simulationBtn = document.getElementById('simulationDataBtn');
            const api12306Btn = document.getElementById('api12306DataBtn');
            const refreshBtn = document.getElementById('refreshDataBtn');
            const dataSourceDisplay = document.getElementById('dataSource');
            
            if (source === 'simulation') {
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                simulationBtn.classList.add('active');
                api12306Btn.classList.remove('active');
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'åˆ·æ–°12306æ•°æ®';
                
                // åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ•°æ®
                trainData = [...simulationTrainData];
                dataSourceDisplay.textContent = 'æ•°æ®æº: æ¨¡æ‹Ÿæ•°æ®';
                
                // é‡æ–°æ¸²æŸ“åˆ—è½¦åˆ—è¡¨
                renderTrainList();
                
            } else if (source === '12306') {
                // ä½¿ç”¨12306æ•°æ®
                simulationBtn.classList.remove('active');
                api12306Btn.classList.add('active');
                refreshBtn.disabled = false;
                
                // æ˜¾ç¤ºåˆå§‹åŒ–çŠ¶æ€
                dataSourceDisplay.textContent = 'æ•°æ®æº: 12306 åˆå§‹åŒ–ä¸­...';
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'åˆå§‹åŒ–ä¸­...';
                
                try {
                    // ç¡®ä¿12306 APIå·²åˆå§‹åŒ–
                    console.log('ğŸ”„ ç¡®ä¿12306 APIå·²åˆå§‹åŒ–...');
                    await railway12306.ensureInitialized();
                    console.log('âœ… 12306 APIåˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹è·å–æ•°æ®');
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'åˆ·æ–°12306æ•°æ®';
                    
                    // å°è¯•è·å–12306æ•°æ®
                    await refreshTrainData();
                } catch (error) {
                    console.error('âŒ 12306 APIåˆå§‹åŒ–å¤±è´¥:', error);
                    
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    alert('12306 APIåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•\né”™è¯¯ä¿¡æ¯: ' + error.message);
                    
                    // å›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®
                    simulationBtn.classList.add('active');
                    api12306Btn.classList.remove('active');
                    refreshBtn.disabled = true;
                    refreshBtn.textContent = 'åˆ·æ–°12306æ•°æ®';
                    currentDataSource = 'simulation';
                    trainData = [...simulationTrainData];
                    dataSourceDisplay.textContent = 'æ•°æ®æº: æ¨¡æ‹Ÿæ•°æ® (åˆå§‹åŒ–å¤±è´¥)';
                    renderTrainList();
                }
            }
        }

        // å°†å‡½æ•°è®¾ç½®ä¸ºå…¨å±€ï¼Œä»¥ä¾¿HTML onclickå¯ä»¥è°ƒç”¨
        window.selectStation = selectStation;
        window.refreshTrainData = refreshTrainData;
        window.setDataSource = setDataSource;
    </script>
</body>
</html>